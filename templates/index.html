<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chẩn đoán Parkinson</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Thêm một số kiểu tùy chỉnh */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f0f7 100%);
            min-height: 100vh;
        }
        /* Tùy chỉnh thanh cuộn */
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f8f9fa;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        /* Hiệu ứng cho input chat */
        #chat-input:focus {
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
            border-color: #14b8a6;
        }
        /* Checkbox lớn hơn cho người cao tuổi */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        /* Animation cho loading */
        @keyframes pulse-gentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-gentle {
            animation: pulse-gentle 2s ease-in-out infinite;
        }
        /* Cải thiện prose styling */
        .prose-custom {
            line-height: 1.8;
        }
        .prose-custom p {
            margin-bottom: 0.75rem;
        }
        .prose-custom strong {
            color: #0f766e;
            font-weight: 600;
        }
        .prose-custom ul, .prose-custom ol {
            margin-left: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .prose-custom li {
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 lg:p-8">

    

        <div class="grid lg:grid-cols-3 gap-8 items-start">
            
            <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 flex flex-col border border-gray-100">
                <h2 class="text-2xl font-bold mb-5 text-teal-800 flex items-center">
                    <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-stethoscope text-teal-600"></i>
                    </div>
                    <span>Khung Chẩn đoán Lâm sàng</span>
                </h2>
                
                <div class="mb-5 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-yellow-400 rounded-lg shadow-sm">
                    <h3 class="text-base font-bold text-yellow-800 mb-2 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Lưu ý quan trọng
                    </h3>
                    <p class="text-base text-yellow-700 leading-relaxed">Đây là công cụ <strong>hỗ trợ sàng lọc</strong>, không thay thế chẩn đoán của bác sĩ. Vui lòng đến gặp chuyên khoa Thần kinh để được thăm khám chính xác.</p>
                </div>

                <form id="symptomForm" class="space-y-6 flex-1 overflow-y-auto pr-2 scrollbar-thin">
                    
                    <fieldset class="border-2 border-teal-100 rounded-xl p-5 bg-gradient-to-br from-teal-50/30 to-white hover:border-teal-200 transition-all duration-200">
                        <legend class="font-bold text-lg text-teal-800 px-3 bg-white">1. Triệu chứng Vận động</legend>
                        <div class="space-y-4 mt-3">
                            <h4 class="font-semibold text-base text-teal-700 border-b border-teal-100 pb-2">Run (Tremor)</h4>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Run khi tay đang thư giãn (run khi nghỉ)" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Run khi tay đang thư giãn (run lúc nghỉ)</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Run bắt đầu ở một bên cơ thể" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Run bắt đầu ở MỘT bên cơ thể</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Run kiểu 'vê thuốc'" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Run giống kiểu "vê thuốc"</span>
                            </label>
                            
                            <div class="border-t border-gray-200 my-3"></div>
                            <h4 class="font-semibold text-base text-teal-700 border-b border-teal-100 pb-2">Chậm vận động (Bradykinesia)</h4>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Khó khăn khi làm việc vặt (cài cúc áo, cắt thức ăn)" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Khó làm việc vặt (cài cúc, cắt thức ăn)</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Chữ viết nhỏ dần (Micrographia)" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Chữ viết tay nhỏ dần</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Nét mặt cứng, ít biểu cảm" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Nét mặt ít biểu cảm ("mặt nạ")</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Khó đứng dậy khỏi ghế hoặc trở mình" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Khó đứng dậy khỏi ghế, khó trở mình</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Bước đi ngắn, kéo lê chân, giảm vung tay" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Bước đi ngắn, kéo lê, ít vung tay</span>
                            </label>

                            <div class="border-t border-gray-200 my-3"></div>
                            <h4 class="font-semibold text-base text-teal-700 border-b border-teal-100 pb-2">Cứng đờ (Rigidity)</h4>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Cảm thấy cơ bắp căng cứng (cổ, vai, hông)" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Cơ bắp căng cứng (cổ, vai, hông)</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Bị đau cơ hoặc chuột rút không rõ nguyên nhân" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Đau cơ, chuột rút không rõ nguyên nhân</span>
                            </label>

                            <div class="border-t border-gray-200 my-3"></div>
                            <h4 class="font-semibold text-base text-teal-700 border-b border-teal-100 pb-2">Mất ổn định Tư thế</h4>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Dễ mất thăng bằng, hay bị vấp ngã" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Dễ mất thăng bằng, hay bị vấp ngã</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-teal-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Dáng đi đổ người về phía trước" class="rounded text-teal-600 mt-1">
                                <span class="leading-relaxed">Dáng đi đổ người về phía trước</span>
                            </label>
                        </div>
                    </fieldset>

                    <fieldset class="border-2 border-blue-100 rounded-xl p-5 bg-gradient-to-br from-blue-50/30 to-white hover:border-blue-200 transition-all duration-200">
                        <legend class="font-bold text-lg text-blue-800 px-3 bg-white">2. Triệu chứng Phi-vận động</legend>
                        <div class="space-y-4 mt-3">
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Giảm hoặc mất khứu giác" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">Giảm hoặc mất khả năng ngửi</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Rối loạn giấc ngủ REM (la hét, cử động mạnh khi ngủ)" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">La hét, cử động mạnh khi ngủ</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Bị táo bón nghiêm trọng, kéo dài" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">Táo bón nghiêm trọng, kéo dài</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Giọng nói nhỏ đi, nói lắp, hoặc khàn" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">Giọng nói nhỏ đi, khàn tiếng</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Thay đổi tâm trạng (trầm cảm, lo âu)" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">Trầm cảm, lo lắng không rõ nguyên nhân</span>
                            </label>
                            <label class="flex items-start space-x-3 text-base cursor-pointer hover:bg-blue-50/50 p-2 rounded-lg transition-colors">
                                <input type="checkbox" value="Chóng mặt, choáng váng khi đứng dậy" class="rounded text-blue-600 mt-1">
                                <span class="leading-relaxed">Chóng mặt khi đứng dậy đột ngột</span>
                            </label>
                        </div>
                    </fieldset>
                </form>

                <button type="submit" form="symptomForm" class="w-full mt-5 bg-gradient-to-r from-teal-600 to-teal-700 text-white py-4 px-4 rounded-xl hover:from-teal-700 hover:to-teal-800 transition-all duration-200 font-bold text-lg shadow-lg hover:shadow-xl">
                    <i class="fas fa-search-plus mr-2"></i>
                    Phân tích Triệu chứng
                </button>
                
                <div id="symptom-result" class="mt-5"></div>
            </div>

            <div class="lg:col-span-2 flex flex-col gap-8">
                
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-5 text-blue-800 flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-camera-retro text-blue-600"></i>
                        </div>
                        <span>Dự đoán qua Hình ảnh Vẽ tay</span>
                    </h2>
                    
                    <form id="upload-form" action="/predict" method="post" enctype="multipart/form-data" class="space-y-5">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all duration-200 cursor-pointer bg-gradient-to-br from-gray-50 to-white">
                            <input type="file" name="image" accept="image/*" class="hidden" id="file-input" required>
                            <label for="file-input" class="cursor-pointer block" id="file-label">
                                <div class="text-gray-400 mb-3">
                                    <svg class="mx-auto h-16 w-16" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </div>
                                <p class="text-lg font-semibold text-gray-700 mb-1">Kéo thả hoặc Bấm để chọn ảnh</p>
                                <p class="text-sm text-gray-500">Hỗ trợ định dạng PNG, JPG, JPEG</p>
                            </label>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-4 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 font-bold text-lg shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed" id="submit-btn">
                            <i class="fas fa-magic mr-2"></i>
                            Phân tích Ảnh
                        </button>
                    </form>
                    <div id="result" class="mt-5"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-6 flex flex-col border border-gray-100" style="height: 650px;">
                    <h2 class="text-2xl font-bold mb-5 text-purple-800 flex items-center border-b border-gray-200 pb-4">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-comments text-purple-600"></i>
                        </div>
                        <span>Trò chuyện với Trợ lý AI</span>
                    </h2>

                    <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 p-4 bg-gradient-to-br from-gray-50 to-gray-100/50 rounded-xl scrollbar-thin" style="max-height: 500px;">
                        <div class="flex justify-start mb-4">
                            <div class="bg-white text-gray-800 rounded-2xl px-5 py-3 max-w-md shadow-md border border-gray-100" style="border-bottom-left-radius: 0.5rem;">
                                <div class="text-base leading-relaxed">Xin chào! Tôi là trợ lý AI. Bạn có câu hỏi gì về bệnh Parkinson không?</div>
                            </div>
                        </div>
                    </div>
                    
                    <form id="chat-form" class="flex space-x-3">
                        <input type="text" name="message" id="chat-input" placeholder="Nhập câu hỏi của bạn..." class="flex-1 border-2 border-gray-200 rounded-full px-6 py-3.5 text-base focus:outline-none focus:border-teal-500 shadow-sm bg-white" required>
                        <button type="submit" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white w-14 h-14 rounded-full flex items-center justify-center hover:from-purple-700 hover:to-purple-800 transition-all duration-200 shadow-md hover:shadow-lg flex-shrink-0">
                            <i class="fas fa-paper-plane text-lg"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Handle file input display
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.getElementById('file-label');
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileLabel.innerHTML = `
                    <div class="text-green-600 mb-2">
                        <svg class="mx-auto h-12 w-12" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <p class="text-lg text-gray-800 font-medium">${file.name}</p>
                `;
            }
        });

        // Handle symptom form
        document.getElementById('symptomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const checkboxes = this.querySelectorAll('input[type="checkbox"]:checked');
            const symptoms = Array.from(checkboxes).map(cb => cb.value);

            if (symptoms.length === 0) {
                alert("Bạn chưa chọn bất kỳ triệu chứng nào. Vui lòng chọn ít nhất một dấu hiệu.");
                return;
            }

            const resultDiv = document.getElementById('symptom-result');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center p-5 bg-teal-50 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-spinner fa-spin text-teal-600 text-2xl"></i>
                        <p class="text-teal-700 font-semibold text-base">Đang phân tích triệu chứng...</p>
                    </div>
                </div>
            `;

            fetch('/analyze_symptoms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ symptoms: symptoms })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="p-5 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-xl font-medium">${data.error}</div>`;
                } else {
                    // Hiển thị kết quả phân tích triệu chứng
                    resultDiv.innerHTML = `
                        <div class="bg-gradient-to-br from-teal-50 to-emerald-50 p-6 rounded-2xl border-2 border-teal-200 shadow-lg mt-5">
                            <h3 class="text-xl font-bold mb-4 text-teal-800 flex items-center">
                                <div class="w-8 h-8 bg-teal-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-poll-h text-white text-sm"></i>
                                </div>
                                Kết quả Phân tích
                            </h3>
                            <div class="text-base leading-loose text-gray-800 prose-custom bg-white p-5 rounded-xl shadow-sm">
                                ${data.analysis} 
                            </div>
                        </div>
                    `;
                    // data.analysis trả về HTML từ server
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="p-5 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-xl font-medium">Lỗi kết nối. Vui lòng thử lại.</div>';
            });
        });

        // Handle predict form
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center p-5 bg-blue-50 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                        <p class="text-blue-700 font-semibold text-base">Đang xử lý và phân tích ảnh...</p>
                    </div>
                </div>
            `;

            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="p-5 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-xl font-medium">${data.error}</div>`;
                } else {
                    // Xác định màu sắc dựa trên label
                    let labelColor = data.label.toLowerCase().includes('healthy') ? 'text-green-600' : 'text-red-600';
                    let confidentColor = data.confident > 0.8 ? 'text-green-700' : (data.confident > 0.5 ? 'text-yellow-600' : 'text-red-600');

                    resultDiv.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-6 rounded-2xl border-2 border-blue-200 shadow-xl">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="flex flex-col">
                                    <div class="bg-white p-3 rounded-xl shadow-md mb-4">
                                        <img src="data:image/jpeg;base64,${data.image_base64}" class="w-full h-auto rounded-lg object-cover">
                                    </div>
                                </div>
                                
                                <div class="flex flex-col justify-between">
                                    <div>
                                        <div class="bg-white p-5 rounded-xl shadow-md mb-4">
                                            <h3 class="text-2xl font-bold ${labelColor} mb-3 flex items-center">
                                                <i class="fas fa-diagnoses mr-3"></i>
                                                ${data.label}
                                            </h3>
                                            
                                            <div class="mb-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-base font-semibold text-gray-700">Độ tin cậy:</span>
                                                    <span class="text-xl font-bold ${confidentColor}">${(data.confident * 100).toFixed(1)}%</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
                                                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 rounded-full transition-all duration-700 shadow-sm" style="width: ${data.confident * 100}%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-5 rounded-xl shadow-md">
                                            <h4 class="font-bold text-lg text-gray-800 mb-4 flex items-center border-b pb-3">
                                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                                    <i class="fas fa-info-circle text-blue-600"></i>
                                                </div>
                                                Thông tin Chi tiết
                                            </h4>
                                            <div class="text-base text-gray-700 leading-loose prose-custom">
                                                ${data.treatment}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="p-5 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-xl font-medium">Lỗi xử lý. Vui lòng thử lại.</div>';
            });
        });

        // Handle chat
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInput = this.message;
            const message = messageInput.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('chat-messages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div class="flex justify-end mb-4">
                    <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-2xl px-5 py-3 max-w-md shadow-md" style="border-bottom-right-radius: 0.5rem;">
                        <div class="text-base leading-relaxed">${message}</div>
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            messageInput.value = '';

            // Add loading indicator
            messagesDiv.innerHTML += `
                <div class="flex justify-start mb-4" id="loading-bubble">
                    <div class="bg-white text-gray-800 rounded-2xl px-5 py-3 max-w-xs shadow-md border border-gray-100">
                        <div class="flex space-x-1">
                            <i class="fas fa-circle text-xs text-gray-400 animate-bounce" style="animation-delay: 0s;"></i>
                            <i class="fas fa-circle text-xs text-gray-400 animate-bounce" style="animation-delay: 0.15s;"></i>
                            <i class="fas fa-circle text-xs text-gray-400 animate-bounce" style="animation-delay: 0.3s;"></i>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading bubble
                document.getElementById('loading-bubble')?.remove();

                // Add AI response
                messagesDiv.innerHTML += `
                    <div class="flex justify-start mb-4">
                        <div class="bg-white text-gray-800 rounded-2xl px-5 py-3 max-w-lg shadow-md border border-gray-100" style="border-bottom-left-radius: 0.5rem;">
                            <div class="text-base leading-loose prose-custom">${data.response}</div>
                        </div>
                    </div>
                `;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            })
            .catch(error => {
                // Remove loading bubble
                document.getElementById('loading-bubble')?.remove();
                
                messagesDiv.innerHTML += `
                    <div class="flex justify-start mb-4">
                        <div class="bg-red-50 text-red-800 rounded-2xl px-5 py-3 max-w-xs border-l-4 border-red-500 font-medium">
                            Lỗi kết nối. Vui lòng thử lại.
                        </div>
                    </div>
                `;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        });
    </script>
</body>
</html>